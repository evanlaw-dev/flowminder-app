<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Nudges Test</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font: 14px/1.4 system-ui, sans-serif; margin: 20px; }
    .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .me { opacity: .6 }
    button { padding: 4px 8px; }
    .pill { padding: 2px 6px; border-radius: 10px; background: #eee; }
  </style>
</head>
<body>
  <h1>Nudges Demo</h1>
  <div id="who"></div>
  <div id="log" style="min-height:1.2em;color:#555"></div>
  <hr>
  <div id="list"></div>

  <script>
    // --- CONFIG ---
    // If your backend runs on another port (e.g. 4000), set it explicitly:
    const BACKEND_URL = "http://localhost:4000"; // <-- change if needed
    const MEETING_ID  = "a8f52a02-5aa8-45ec-9549-79ad2a194fa4";

    // current user (from ?user= or prompt)
    const url = new URL(location.href);
    const USER_ID = url.searchParams.get("user") || prompt("Fake user id (e.g., alice, bob):");

    document.getElementById("who").textContent = `Meeting: ${MEETING_ID} | You are: ${USER_ID}`;
    const log = (msg) => { document.getElementById("log").textContent = msg || ""; };

    // state
    const state = { participants: [] };

    function render() {
      const el = document.getElementById("list");
      el.innerHTML = "";
      state.participants.forEach(p => {
        const row = document.createElement("div");
        row.className = "row" + (p.user_id === USER_ID ? " me" : "");
        row.innerHTML = `
          <span class="pill">${p.in_meeting ? "üü¢" : "‚ö™Ô∏è"}</span>
          <strong>${p.name || p.user_id}</strong>
          <span>‚Üë ${p.more}</span>
          <span>‚Üì ${p.less}</span>
          ${p.user_id === USER_ID ? "<em>(you)</em>" : `
            <button data-k="more" data-id="${p.user_id}">Speak more</button>
            <button data-k="less" data-id="${p.user_id}">Speak less</button>
          `}
        `;
        el.appendChild(row);
      });

      el.querySelectorAll("button").forEach(btn => {
        btn.onclick = () => {
          const targetId = btn.getAttribute("data-id");
          const kind = btn.getAttribute("data-k");
          socket.emit("nudge:cast", { meetingId: MEETING_ID, voterId: USER_ID, targetId, kind });
        };
      });
    }

    // define socket up-front (listeners can be attached before connect)
    const socket = io(BACKEND_URL, { path: "/socket.io", transports: ["websocket"], withCredentials: true });

    socket.on("connect_error", (err) => log("Socket error: " + err.message));
    socket.on("nudge:snapshot", ({ participants }) => { state.participants = participants; render(); });
    socket.on("nudge:participant:update", (p) => {
      const i = state.participants.findIndex(x => x.user_id === p.user_id);
      if (i === -1) state.participants.push(p); else state.participants[i] = p;
      state.participants.sort((a,b)=> (a.name||a.user_id).localeCompare(b.name||b.user_id));
      render();
    });
    socket.on("nudge:update", ({ targetId, more, less }) => {
      const t = state.participants.find(p => p.user_id === targetId);
      if (t) { t.more = more; t.less = less; render(); }
    });
    socket.on("nudge:rejected", ({ reason, remainingMs }) => {
      if (reason === "cooldown") {
        log(`‚è≥ Cooldown ~${Math.ceil((remainingMs || 0) / 1000)}s`);
      } else if (reason === "target_not_in_meeting") {
        log("Target not in meeting");
      } else {
        log("Action rejected");
      }
      setTimeout(()=>log(""), 1500);
    });

    // main: create roster row, then connect socket & join room
    (async function main() {
      try {
        const r = await fetch(`${BACKEND_URL}/dev/roster/join`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ meetingId: MEETING_ID, userId: USER_ID, name: USER_ID }),
        });
        if (!r.ok) throw new Error(await r.text());

        socket.connect();
        socket.emit("joinMeeting", MEETING_ID);
      } catch (err) {
        alert("Join failed: " + (err?.message || err));
      }
    })();
  </script>
</body>
</html>
